name: CI

on:
  pull_request:
  push:
    branches: [ "main" ]

jobs:
  # Unit tests without external dependencies
  unit-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Run unit tests (JUnit)
        run: |
          mkdir -p reports
          npm run test:junit

      - name: Upload test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit-report
          path: reports/junit.xml

  # Integration tests with Docker services (Postgres, Redis, Engine)
  integration-tests:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: app
          POSTGRES_PASSWORD: app
          POSTGRES_DB: app_test
        options: >-
          --health-cmd="pg_isready -U app -d app_test"
          --health-interval=5s
          --health-timeout=3s
          --health-retries=20
        ports:
          - 5432:5432

      redis:
        image: redis:7
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=5s
          --health-timeout=3s
          --health-retries=20
        ports:
          - 6379:6379

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install
        run: npm ci

      # Defensive wait loops to ensure services are truly ready
      - name: Wait for Postgres
        run: |
          for i in {1..30}; do
            node -e '
              const { Pool } = require("pg");
              const pool = new Pool({ connectionString: process.env.DATABASE_URL });
              pool.query("SELECT 1").then(() => {
                pool.end();
                process.exit(0);
              }).catch(() => {
                pool.end();
                process.exit(1);
              });
            ' && exit 0
            sleep 2
          done
          echo "Postgres not ready after 60s" && exit 1
        env:
          DATABASE_URL: postgres://app:app@localhost:5432/app_test

      - name: Wait for Redis
        run: |
          for i in {1..30}; do
            node -e '
              const { createClient } = require("redis");
              const client = createClient({ url: process.env.REDIS_URL });
              client.on("error", () => process.exit(1));
              client.connect()
                .then(() => client.ping())
                .then(() => client.quit())
                .then(() => process.exit(0))
                .catch(() => process.exit(1));
            ' && exit 0
            sleep 2
          done
          echo "Redis not ready after 60s" && exit 1
        env:
          REDIS_URL: redis://localhost:6379

      - name: Start Mock Engine
        run: npm run engine:start &
        env:
          DATABASE_URL: postgres://app:app@localhost:5432/app_test
          REDIS_URL: redis://localhost:6379
          NODE_ENV: test

      - name: Wait for Engine
        run: |
          for i in {1..40}; do
            curl -fsS http://localhost:8080/health && exit 0
            sleep 2
          done
          echo "Engine not ready after 80s" && exit 1

      - name: Run integration tests
        env:
          DATABASE_URL: postgres://app:app@localhost:5432/app_test
          REDIS_URL: redis://localhost:6379
          API_BASE_URL: http://localhost:8080
          WS_URL: ws://localhost:8081
        run: npm run test:integration

      - name: Upload integration test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-report
          path: reports/junit-integration.xml

      - name: Publish test results
        if: always()
        run: npm run publish:results
        env:
          SQUASH_ENDPOINT: ${{ secrets.SQUASH_ENDPOINT }}
          SQUASH_TOKEN: ${{ secrets.SQUASH_TOKEN }}

  # E2E tests with UI + API (Playwright)
  e2e-tests:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: app
          POSTGRES_PASSWORD: app
          POSTGRES_DB: app_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U app -d app_test"
          --health-interval=5s
          --health-timeout=3s
          --health-retries=20

      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping | grep PONG"
          --health-interval=5s
          --health-timeout=3s
          --health-retries=20

      engine:
        # Use GHCR images published by publish-images.yml workflow
        # Replace with your GitHub username after publishing images
        image: ghcr.io/${{ github.repository_owner }}/mock-engine:latest
        ports:
          - 8080:8080
        env:
          DATABASE_URL: postgres://app:app@postgres:5432/app_test
          REDIS_URL: redis://redis:6379
        options: >-
          --health-cmd="wget -qO- http://localhost:8080/health | grep ok"
          --health-interval=5s
          --health-timeout=3s
          --health-retries=10

      web:
        image: ghcr.io/${{ github.repository_owner }}/mock-web:latest
        ports:
          - 3000:3000
        env:
          ENGINE_URL: http://engine:8080
        options: >-
          --health-cmd="wget -qO- http://localhost:3000/ | grep Client"
          --health-interval=5s
          --health-timeout=3s
          --health-retries=10

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install deps
        run: npm ci

      - name: Wait for Engine
        run: |
          for i in {1..40}; do
            curl -fsS http://localhost:8080/health && exit 0
            sleep 2
          done
          echo "Engine not ready" && exit 1

      - name: Wait for Web
        run: |
          for i in {1..40}; do
            curl -fsS http://localhost:3000/ >/dev/null && exit 0
            sleep 2
          done
          echo "Web not ready" && exit 1

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Run Playwright (JUnit)
        env:
          CI: "true"
          WEB_BASE_URL: http://localhost:3000
          ENGINE_URL: http://localhost:8080
          WS_URL: ws://localhost:8080/ws
        run: |
          mkdir -p reports
          npm run test:e2e

      - name: Upload E2E JUnit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-junit-report
          path: reports/junit.xml
